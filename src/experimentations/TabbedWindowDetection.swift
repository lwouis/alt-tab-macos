import Foundation
import ScreenCaptureKit

if #available(macOS 13.1, *) {
    SCShareableContent.getExcludingDesktopWindows(true, onScreenWindowsOnly: false) { content, error in
        let normal = content!.windows.first { $0.windowID == 9345 }!
        let tabbed = content!.windows.first { $0.windowID == 9867 }!
        let hidden = content!.windows.first { $0.windowID == 10690 }!
        Logger.error("normal", normal.title, normal.isActive, normal.isOnScreen, normal.windowLayer, normal.frame)
        Logger.error("tabbed", tabbed.title, tabbed.isActive, tabbed.isOnScreen, tabbed.windowLayer, tabbed.frame)
        Logger.error("hidden", hidden.title, hidden.isActive, hidden.isOnScreen, hidden.windowLayer, hidden.frame)
        Logger.error("SCShareableContent", content!.windows.sorted { $0.windowID < $1.windowID }.map { $0.windowID })
    }
}
let windows = CGWindowListCopyWindowInfo([.excludeDesktopElements, .optionOnScreenOnly], kCGNullWindowID) as! [CGWindow]
Logger.error("CGWindowListCopyWindowInfo extra", windows.sorted { $0.id()! < $1.id()! }.map { ($0.id()!, $0.title()) })
Logger.error("CGWindowListCopyWindowInfo", windows.sorted { $0.id()! < $1.id()! }.map { $0.id()! })
Spaces.refresh()
let spaceIdsAndIndexes = Spaces.idsAndIndexes.map { $0.0 }
let cgsWindowIds = Spaces.windowsInSpaces(spaceIdsAndIndexes)
let visibleCgsWindowIds = Spaces.windowsInSpaces(spaceIdsAndIndexes, false)
Logger.error("CGSCopyWindowsWithOptionsAndTags include invisible", cgsWindowIds.sorted { $0 < $1 })
Logger.error("CGSCopyWindowsWithOptionsAndTags exclude invisible", visibleCgsWindowIds.sorted { $0 < $1 })


// CGWindowListCopyWindowInfo extra [(28, "Clock"), (29, "Sound"), (30, "BentoBox-0"), (31, "Item-0"), (42, "Item-0"), (49, "Item-1"), (57, "Item-0"), (59, "raycastIcon"), (79, "Item-0"), (87, "Item-0"), (125, "com.bjango.istatmenus.memory"), (126, "com.bjango.istatmenus.battery"), (127, "com.bjango.istatmenus.cpu"), (128, "com.bjango.istatmenus.disks"), (129, "com.bjango.istatmenus.network"), (130, "com.bjango.istatmenus.sensors"), (131, "com.bjango.istatmenus.time"), , (9297, "BetterTouchTool"), (9325, ""), (9345, "alt-tab-macos [~/git/alt-tab-macos] â€“ /Users/lwouis/git/alt-tab-macos/src/ui/App.swift"), (11123, "Item-0"), (11160, "Menubar"), (11281, "StatusIndicator")]
// SCShareableContent extra [(2, Optional("Display 1 Backstop")), (3, Optional("Display 2 Backstop")), (5, Optional("Cursor")), (16, Optional("Dock")), (19, Optional("")), (20, Optional("Notification Center")), (21, Optional("Accessibility")), (23, Optional("")), (24, Optional("")), (25, Optional("")), (26, Optional("")), (27, Optional("")), (28, Optional("Clock")), (29, Optional("Sound")), (30, Optional("BentoBox-0")), (31, Optional("Item-0")), (37, Optional("")), (42, Optional("Item-0")), (44, Optional("Spotlight")), (45, Optional("Spotlight")), (49, Optional("Item-1")), (56, Optional("")), (57, Optional("Item-0")), (58, Optional("")), (59, Optional("raycastIcon")), (61, Optional("")), (64, Optional("")), (72, Optional("")), (76, Optional("Logger.error(\"CGWindowâ€¦itle() ?? \"nil\") })... (2 lines)")), (79, Optional("Item-0")), (85, Optional("Handy")), (86, Optional("Recording")), (87, Optional("Item-0")), (95, Optional("")), (96, Optional("")), (97, Optional("")), (98, Optional("")), (99, Optional("")), (100, Optional("")), (101, Optional("")), (102, Optional("")), (103, Optional("")), (104, Optional("")), (105, Optional("")), (106, Optional("")), (107, Optional("")), (108, Optional("")), (109, Optional("")), (110, Optional("")), (111, Optional("")), (112, Optional("")), (113, Optional("")), (114, Optional("")), (115, Optional("")), (116, Optional("")), (117, Optional("")), (118, Optional("")), (119, Optional("")), (121, Optional("")), (122, Optional("")), (123, Optional("")), (124, Optional("")), (125, Optional("com.bjango.istatmenus.memory")), (126, Optional("com.bjango.istatmenus.battery")), (127, Optional("com.bjango.istatmenus.cpu")), (128, Optional("com.bjango.istatmenus.disks")), (129, Optional("com.bjango.istatmenus.network")), (130, Optional("com.bjango.istatmenus.sensors")), (131, Optional("com.bjango.istatmenus.time")), (132, Optional("")), (140, Optional("")), (202, Optional("(25811) Subscriptions - YouTube")), (203, Optional("")), (204, Optional("")), ), (206, Optional("")), (207, Optional("")), (215, Optional("")), (289, Optional("")), (334, Optional("")), (875, Optional("")), (1713, Optional("Display 2 Backstop")), (2148, Optional("")), (2150, Optional("")), (3302, Optional("")), (4384, Optional("")), (6249, Optional("Display 2 Backstop")), (9296, Optional("Colors")), (9297, Optional("BetterTouchTool")), (9309, Optional("")), (9310, Optional("")), (9311, Optional("")), (9312, Optional("")), (9313, Optional("Display 2 Backstop")), (9314, Optional("")), (9315, Optional("")), (9316, Optional("")), (9317, Optional("")), (9318, Optional("")), (9319, Optional("")), (9320, Optional("")), (9321, Optional("")), (9322, Optional("")), (9324, Optional("")), (9325, Optional("")), (9328, Optional("Wallpaper-6D2AE1E5-4293-4F35-A980-0E81D9E360BF")), (9329, Optional("")), (9331, Optional("")), (9339, Optional("")), (9340, Optional("")), (9341, Optional("")), (9342, Optional("")), (9343, Optional("")), , (9346, Optional("")), (9450, Optional("")), (9451, Optional("")), (9452, Optional("")), (9453, Optional("")), (9454, Optional("")), , (9456, Optional("")), , (9875, Optional("")), (9972, Optional("Wallpaper-9FA063D2-E6B4-4569-82CC-3C345CB5BEAD")), (9978, Optional("Offscreen Wallpaper Window")), (9995, Optional("Menubar")), (9996, Optional("underbelly")), , (10021, Optional("")), (10022, Optional("")), (10025, Optional("")), (10026, Optional("Wallpaper-1448183E-49F8-4B98-90FA-4D983B169ECD")), (10027, Optional("Fullscreen Backdrop")), (10028, Optional("")), (10032, Optional("")), (10033, Optional("")), (10034, Optional("")), (10035, Optional("com.lwouis.menubar-webview")), (10036, Optional("com.lwouis.webcam-zoom")), (10037, Optional("com.naotanhaocan.BetterMouse")), (10038, Optional("pro.betterdisplay.BetterDisplay")), (10039, Optional("com.raycast.macos")), (10040, Optional("io.github.hluk.CopyQ")), (10041, Optional("com.pais.handy")), (10042, Optional("com.bjango.istatmenus.status")), (10043, Optional("com.bjango.istatmenus.status")), (10044, Optional("com.bjango.istatmenus.status")), (10045, Optional("com.bjango.istatmenus.status")), (10046, Optional("com.bjango.istatmenus.status")), (10047, Optional("com.bjango.istatmenus.status")), (10048, Optional("com.bjango.istatmenus.status")), (10049, Optional("com.hegenberg.BetterTouchTool")), (10246, Optional("Menubar")), (10247, Optional("underbelly")), (10417, nil), (10419, Optional("Gesture Blocking Overlay")), (10443, Optional("Gesture Blocking Overlay")), (10469, nil), (10572, Optional("Keyboard Input")), , (10694, Optional("")), (10952, Optional("")), (11036, Optional("")), (11119, Optional("")), (11120, Optional("AltTab needs some permissions")), (11121, Optional("")), (11122, Optional("")), (11123, Optional("Item-0")), (11124, Optional("com.lwouis.alt-tab-macos")), (11125, Optional("General")), (11126, Optional("")), (11127, Optional("")), (11128, Optional("")), (11129, Optional("")), (11130, Optional("Send feedback")), (11160, Optional("Menubar")), (11161, Optional("underbelly")), (11162, nil), (11164, Optional("")), (11204, Optional("")), (11246, Optional("AudioVideoModule")), (11247, Optional("")), (11280, Optional("")), (11281, Optional("StatusIndicator"))]

// 1. CGWindowListCopyWindowInfo                                                       [28, 29, 30, 31, 42, 49, 57, 59, 79, 87, 125, 126, 127, 128, 129, 130, 131, 202, 9297, 9325, 9345, 11123, 11160, 11281]
// 2. CGSCopyWindowsWithOptionsAndTags include invisible                               [21, 28, 29, 30, 31, 42, 45, 49, 57, 59, 76, 79, 85, 86, 87, 125, 126, 127, 128, 129, 130, 131, 202, 203, 204, 205, 289, 334, 3302, 9297, 9325, 9328, 9345, 9455, 9972, 9978, 9995, 9996, 10020, 10021, 10022, 10025, 10026, 10027, 10028, 10246, 10247, 10419, 10443, 10690, 10694, 11121, 11123, 11160, 11161, 11246]
// 3. CGSCopyWindowsWithOptionsAndTags exclude invisible                               [28, 29, 30, 31, 42, 49, 57, 59, 79, 87, 125, 126, 127, 128, 129, 130, 131, 202, 9297, 9325, 9328, 9345, 9455, 9972, 9978, 9995, 10020, 10021, 10022, 10025, 10026, 10027, 11123, 11160]
// 4. SCShareableContent.getWithCompletionHandler                                      [2, 3, 5, 16, 19, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31, 37, 42, 44, 45, 49, 56, 57, 58, 59, 61, 64, 72, 76, 79, 85, 86, 87, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 140, 202, 203, 204, 205, 206, 207, 215, 289, 334, 875, 1713, 2148, 2150, 3302, 4384, 6249, 9296, 9297, 9309, 9310, 9311, 9312, 9313, 9314, 9315, 9316, 9317, 9318, 9319, 9320, 9321, 9322, 9324, 9325, 9328, 9329, 9331, 9339, 9340, 9341, 9342, 9343, 9345, 9346, 9450, 9451, 9452, 9453, 9454, 9455, 9456, 9867, 9875, 9972, 9978, 9995, 9996, 10020, 10021, 10022, 10025, 10026, 10027, 10028, 10032, 10033, 10034, 10035, 10036, 10037, 10038, 10039, 10040, 10041, 10042, 10043, 10044, 10045, 10046, 10047, 10048, 10049, 10246, 10247, 10417, 10419, 10443, 10469, 10572, 10690, 10694, 10952, 11036, 11119, 11120, 11121, 11122, 11123, 11124, 11125, 11126, 11127, 11128, 11129, 11130, 11160, 11161, 11162, 11164, 11204, 11246, 11247, 11280, 11281]
// 5. SCShareableContent.getExcludingDesktopWindows(true, onScreenWindowsOnly: false)  [5, 16, 20, 21, 23, 24, 25, 26, 27, 28, 29, 30, 31, 37, 42, 44, 45, 49, 56, 57, 58, 59, 61, 64, 72, 76, 79, 85, 86, 87, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 140, 202, 203, 204, 205, 206, 207, 215, 289, 334, 875, 2148, 2150, 3302, 4384, 9296, 9297, 9309, 9310, 9311, 9312, 9314, 9315, 9316, 9317, 9318, 9319, 9320, 9321, 9322, 9324, 9325, 9329, 9331, 9339, 9340, 9341, 9342, 9343, 9345, 9346, 9450, 9451, 9452, 9453, 9454, 9455, 9456, 9867, 9875, 9995, 10020, 10021, 10022, 10025, 10028, 10032, 10033, 10034, 10035, 10036, 10037, 10038, 10039, 10040, 10041, 10042, 10043, 10044, 10045, 10046, 10047, 10048, 10049, 10246, 10419, 10443, 10469, 10690, 10694, 10952, 11119, 11120, 11121, 11122, 11123, 11124, 11125, 11126, 11127, 11128, 11129, 11130, 11160, 11162, 11164, 11204, 11246, 11247, 11334, 11336, 11348]

// (202, Optional("(25811) Subscriptions - YouTube") | normal | 1,2,3,4
// (9345, Optional("alt-tab-macos [~/git/alt-tab-macos] â€“ /Users/lwouis/git/alt-tab-macos/src/ui/App.swift")) | normal | 1,2,3,4
// (10690, Optional("Movies")) | hidden | 2,4
// (9867, Optional("lwouis")) | hidden + tabbed | 4
// (9455, Optional("~/git/alt-tab-macos/DerivedData/Build/Products/Release")) | another space | 2,3,4
// (10020, Optional("(25811) Ryuichi Sakamoto: Playing the Piano for the Isolated - YouTube ðŸ”Š")) | fullscreen | 2,3,4
// (205, Optional("(9+) K8s Migration Eng Test Day - Objectives & Guidelines") | minimized | 2,4

// Conclusions:
// * CGWindowListCopyWindowInfo returns the least windows
// * SCShareableContent returns the most windows
// * In order to detect tabs, we need some difference with non-tabbed windows. We need contrast.
//   Today we make 2 calls to CGSCopyWindowsWithOptionsAndTags, with different options, and compare results.
